{% extends 'base.html' %} 
{% block title %}Admin Dashboard - Quiz Master{% endblock %} 

{# Chart.js library will be loaded at the end of the content block #}

{% block content %}
<div class="row mb-4">
  <div class="col-12 d-flex justify-content-between align-items-center">
    <h2 class="mb-0">Admin Dashboard</h2>
    <a href="{{ url_for('admin.add_subject') }}" class="btn btn-primary">
      <i class="bi bi-plus-circle"></i> Add New Subject
    </a>
  </div>
</div>

<div class="row">
  {% if subjects %} {% for subject in subjects %}
  <div class="col-md-6 mb-4">
    <div class="card h-100">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <h5 class="mb-0">{{ subject.name }}</h5>
        <div>
          <a
            href="{{ url_for('admin.edit_subject', id=subject.id) }}"
            class="btn btn-sm btn-outline-warning me-1"
            title="Edit Subject"
            aria-label="Edit Subject {{ subject.name }}" {# Added aria-label #}
          >
            <i class="bi bi-pencil"></i>
          </a>
          <button
            type="button"
            class="btn btn-sm btn-outline-danger"
            data-bs-toggle="modal"
            data-bs-target="#deleteSubjectModal-{{ subject.id }}"
            title="Delete Subject"
            aria-label="Delete Subject {{ subject.name }}" {# Added aria-label #}
          >
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
      <div class="card-body">
        <p>{{ subject.description }}</p>
        <h6>Chapters:</h6>
        {% if subject.chapters %}
        <ul class="list-group list-group-flush">
          {% for chapter in subject.chapters %} {# Calculate total questions for
          the chapter #} {% set total_questions = namespace(count=0) %} {% for
          quiz in chapter.quizzes %} {% set total_questions.count =
          total_questions.count + (quiz.questions | length) %} {% endfor %}

          <li
            class="list-group-item d-flex justify-content-between align-items-center"
          >
            {# Chapter Name Link #}
            <a href="{{ url_for('admin.quizzes', chapter_id=chapter.id) }}"
              >{{ chapter.name }}</a
            >

            {# Chapter Actions and Counts Group #}
            <div class="btn-group btn-group-sm">
              {# Display Quiz Count as disabled button #}
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                title="Number of Quizzes"
              >
                {{ chapter.quizzes | length }} Quizzes
              </button>
              {# Display Question Count as disabled button #}
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                title="Total Questions"
              >
                {{ total_questions.count }} Qs
              </button>
              {# Edit Button #}
              <a
                href="{{ url_for('admin.edit_chapter', id=chapter.id) }}"
                class="btn btn-sm btn-outline-warning"
                title="Edit Chapter"
                aria-label="Edit Chapter {{ chapter.name }}" {# Added aria-label #}
              >
                <i class="bi bi-pencil"></i>
              </a>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                data-bs-toggle="modal"
                data-bs-target="#deleteChapterModal-{{ chapter.id }}"
                title="Delete Chapter"
                aria-label="Delete Chapter {{ chapter.name }}" {# Added aria-label #}
              >
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </li>
          {% endfor %} {# End chapter loop #}
        </ul>
        
        {# Move Modals outside the UL but keep within the subject loop #}
        {% for chapter in subject.chapters %}
          <!-- Delete Chapter Modal for {{ chapter.name }} -->
          <div
            class="modal fade"
            id="deleteChapterModal-{{ chapter.id }}"
            tabindex="-1"
            aria-hidden="true"
          >
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Confirm Delete Chapter</h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  Are you sure you want to delete chapter "{{ chapter.name }}"?
                  This will delete all associated quizzes and questions.
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    Cancel
                  </button>
                  <form
                    action="{{ url_for('admin.delete_chapter', id=chapter.id) }}"
                    method="POST"
                    class="d-inline"
                  >
                    <button type="submit" class="btn btn-danger">
                      Delete Chapter
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        {% endfor %} {# End modal loop #}
        {% else %}
        <p class="text-muted">No chapters added yet.</p>
        {% endif %}
      </div>
      <div class="card-footer text-end">
        <a
          href="{{ url_for('admin.add_chapter', subject_id=subject.id) }}"
          class="btn btn-sm btn-success"
        >
          <i class="bi bi-plus-lg"></i> Add Chapter
        </a>
      </div>
    </div>
  </div>

  <!-- Delete Subject Modal -->
  <div
    class="modal fade"
    id="deleteSubjectModal-{{ subject.id }}"
    tabindex="-1"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Delete Subject</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete subject "{{ subject.name }}"? This
          will delete all associated chapters, quizzes, and questions.
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <form
            action="{{ url_for('admin.delete_subject', id=subject.id) }}"
            method="POST"
            class="d-inline"
          >
            <button type="submit" class="btn btn-danger">Delete Subject</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endfor %} {% else %}
  <div class="col-12">
    <div class="alert alert-info">
      No subjects created yet. Click "Add New Subject" to get started.
    </div>
  </div>
  {% endif %}
</div>

{# --- Keep Charts Section (Can be removed if not desired) --- #}
<hr class="my-5" />
<h3 class="text-center mb-4">Summary Statistics</h3>

<!-- Charts Row 1 -->
<div class="row mb-4">
  <!-- Quizzes per Subject Chart -->
  <div class="col-md-6 mb-4">
    <div class="card h-100">
      <div class="card-header bg-secondary text-white">
        <h5>Quizzes per Subject</h5>
      </div>
      <div class="card-body">
        {% if subject_labels and quiz_counts_data %}
        <canvas id="quizzesPerSubjectChart"></canvas>
        {% else %}
        <p class="text-muted">
          No subject or quiz data available to display chart.
        </p>
        {% endif %}
      </div>
    </div>
  </div>
  <!-- User Registration Trend Chart -->
  <div class="col-md-6 mb-4">
    <div class="card h-100">
      <div class="card-header bg-primary text-white">
        <h5>User Registrations Over Time</h5>
      </div>
      <div class="card-body">
        {% if registration_labels and registration_data %}
        <canvas id="userRegistrationChart"></canvas>
        {% else %}
        <p class="text-muted">No user registration data available.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Charts Row 2 -->
<div class="row mb-4">
  <!-- Average Score per Quiz Chart -->
  <div class="col-12">
    <div class="card">
      <div class="card-header bg-success text-white">
        <h5>Average Score per Quiz</h5>
      </div>
      <div class="card-body">
        {% if avg_quiz_labels and avg_quiz_data %}
        <canvas id="avgScorePerQuizChart"></canvas>
        {% else %}
        <p class="text-muted">No quiz score data available.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{# Embed data in a JSON script tag #}
<script id="adminChartData" type="application/json">
  {{ {
      "subjectLabels": subject_labels,
      "quizCountsData": quiz_counts_data,
      "registrationLabels": registration_labels,
      "registrationData": registration_data,
      "avgQuizLabels": avg_quiz_labels,
      "avgQuizData": avg_quiz_data
  }|tojson|safe }}
</script>

{# Load Chart.js library *before* the initialization script #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 

{# Chart Initialization Script #}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // ---  function to create charts ---
    function createChart(canvasId, chartType, chartData, chartOptions = {}) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) {
        console.error(`Canvas element with ID '${canvasId}' not found.`);
        return;
      }
      // checks if essential data arrays exist and are not empty
      if (!chartData || !chartData.labels || chartData.labels.length === 0 || !chartData.datasets || chartData.datasets.length === 0 || !chartData.datasets[0].data || chartData.datasets[0].data.length === 0) {
        console.warn(`No valid data provided for chart '${canvasId}'.`);
        return; 
      }

      try {
  
        if (typeof Chart === 'undefined') {
            console.error('Chart.js library is not loaded or available.');
            return;
        }
        const ctx = canvas.getContext("2d");
        new Chart(ctx, {
          type: chartType,
          data: chartData,
          options: chartOptions,
        });
      } catch (e) {
        console.error(`Error creating chart '${canvasId}':`, e);
      }
    }

    // --- Get Embedded Chart Data ---
    let adminChartData = {};
    try {
      const chartDataElement = document.getElementById("adminChartData");
      if (chartDataElement) {
        adminChartData = JSON.parse(chartDataElement.textContent || "{}");
      } else {
        console.error("Admin chart data script tag not found.");
      }
    } catch (e) {
      console.error("Error parsing admin chart data JSON:", e);
    }

    // 1. Quizzes per Subject Chart
    createChart(
      "quizzesPerSubjectChart",
      "bar",
      {
        labels: adminChartData.subjectLabels,
        datasets: [
          {
            label: "# of Quizzes",
            data: adminChartData.quizCountsData,
            backgroundColor: "rgba(54, 162, 235, 0.6)",
            borderColor: "rgba(54, 162, 235, 1)",
            borderWidth: 1,
          },
        ],
      },
    );

    // 2. User Registration Trend Chart
    createChart(
      "userRegistrationChart",
      "line",
      {
        labels: adminChartData.registrationLabels,
        datasets: [
          {
            label: "Registrations",
            data: adminChartData.registrationData,
            borderColor: "rgb(255, 99, 132)",
            tension: 0.1,
            fill: false,
          },
        ],
      },
      {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: "No. of Users Registered" },
          },
          x: {
            title: { display: true, text: "Date" },
          },
        },
        plugins: { legend: { display: false } },
      }
    );

    // 3. Average Score per Quiz Chart
    createChart(
      "avgScorePerQuizChart",
      "bar",
      {
        labels: adminChartData.avgQuizLabels,
        datasets: [
          {
            label: "Average Score (%)",
            data: adminChartData.avgQuizData,
            backgroundColor: "rgba(75, 192, 192, 0.6)",
            borderColor: "rgba(75, 192, 192, 1)",
            borderWidth: 1,
          },
        ],
      },
      {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            title: { display: true, text: "Average Score (%)" },
          },
          x: {
            title: { display: true, text: "Quiz ID" },
          },
        },
        plugins: { legend: { display: false } },
      }
    );
  });
</script>

{# Date adapter is not needed for these charts #}
{# 
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script> 
#} 
{% endblock %}
