{% extends 'base.html' %}

{% block title %}User Dashboard - Quiz Master{% endblock %}

{# Add page-specific CSS link #}
{% block head %}
    {{ super() }} {# Includes CSS from base.html #}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{# Chart.js library and adapter will be loaded at the end of the content block #}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">User Dashboard</h2>
        <div class="alert alert-info">
            Welcome, {{ current_user.full_name }}! From here you can browse subjects, take quizzes, and view your scores.
        </div>
    </div>
</div>

<!-- Upcoming Quizzes Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5>Upcoming Quizzes</h5>
            </div>
            <div class="card-body">
                {% if upcoming_quizzes %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Quiz</th>
                                    <th>No. of Questions</th>
                                    <th>Date</th>
                                    <th>Duration</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for quiz in upcoming_quizzes %}
                                <tr>
                                    <td>{{ quiz.id }}</td>
                                    <td>{{ quiz.chapter.subject.name }} - {{ quiz.chapter.name }}</td>
                                    <td>{{ quiz.questions | length }}</td>
                                    <td>{{ quiz.date_of_quiz.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ quiz.time_duration }} mins</td>
                                    <td>
                                        {# Link View to the chapter's quizzes page #}
                                        <a href="{{ url_for('user.quizzes', chapter_id=quiz.chapter_id) }}" class="btn btn-sm btn-outline-secondary me-1" title="View Quizzes in Chapter">View</a>
                                        {# Link Start to the start_quiz page #}
                                        {# Add logic later to disable Start if already attempted or date is not today #}
                                        <a href="{{ url_for('user.start_quiz', quiz_id=quiz.id) }}" class="btn btn-sm btn-success" title="Start Quiz">Start</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No upcoming quizzes scheduled.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>


<!-- Stats cards -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5>Your Stats</h5>
            </div>
            <div class="card-body">
                {# Updated stat boxes to use .stat-box class #}
                <div class="row">
                    <div class="col-md-6">
                        <div class="stat-box">
                            <h3>{{ total_attempts }}</h3>
                            <p class="text-muted mb-0">Total Quizzes Attempted</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="stat-box">
                            <h3>{{ average_score|round(1) }}%</h3>
                            <p class="text-muted mb-0">Average Score</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5>Recent Quiz Attempts</h5>
            </div>
            <div class="card-body">
                {% if scores %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Quiz</th>
                                <th>Score</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {# Use the original scores list, slice first 5 #}
                            {% for score in scores[:5] %} 
                            <tr>
                                <td>{{ score.quiz.chapter.subject.name }} - {{ score.quiz.chapter.name }}</td>
                                <td>{{ score.total_scored }}%</td>
                                <td>{{ score.time_stamp_of_attempt.strftime('%Y-%m-%d') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if scores|length > 5 %}
                    <div class="text-end">
                        <a href="{{ url_for('user.history') }}" class="btn btn-sm btn-outline-primary">See all attempts</a>
                    </div>
                {% endif %}
                {% else %}
                <p class="text-muted">You haven't attempted any quizzes yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Score Trend Chart -->
    <div class="col-lg-8 mb-4"> 
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5>Your Score Trend</h5>
            </div>
            <div class="card-body">
                {% if score_labels and score_data %}
                    <canvas id="scoreTrendChart"></canvas> 
                {% else %}
                    <p class="text-muted">Attempt more quizzes to see your score trend.</p>
                {% endif %}
            </div>
        </div>
    </div>
     <!-- Attempts per Subject Chart -->
    <div class="col-lg-4 mb-4"> 
        <div class="card h-100">
            <div class="card-header bg-warning text-dark">
                <h5>Attempts per Subject</h5>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center"> 
                {% if attempt_subject_labels and attempt_subject_data %}
                    <canvas id="attemptsPerSubjectChart"></canvas> 
                {% else %}
                    <p class="text-muted">No attempt data available.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Average Score per Subject Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5>Average Score per Subject</h5>
            </div>
            <div class="card-body">
                 {% if avg_score_subject_labels and avg_score_subject_data %}
                    <canvas id="avgScorePerSubjectChart"></canvas> 
                {% else %}
                    <p class="text-muted">No average score data available.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{# Embed data in a JSON script tag #}
<script id="userChartData" type="application/json">
    {{ {
        "scoreLabels": score_labels,
        "scoreData": score_data,
        "attemptLabels": attempt_subject_labels,
        "attemptData": attempt_subject_data,
        "avgScoreLabels": avg_score_subject_labels,
        "avgScoreData": avg_score_subject_data
    }|tojson|safe }}
</script>

{# Load Chart.js and Date Adapter *before* the initialization script #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

{# Chart Initialization Script #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Helper function to create charts ---
    function createChart(canvasId, chartType, chartData, chartOptions = {}) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) {
            console.error(`Canvas element with ID '${canvasId}' not found.`);
            return;
        }
        // Basic check if essential data arrays exist and are not empty
        // Adjusted check for pie charts where datasets[0].data might be the only data array
         if (!chartData || !chartData.labels || chartData.labels.length === 0 || !chartData.datasets || chartData.datasets.length === 0 || !chartData.datasets[0].data || chartData.datasets[0].data.length === 0) {
            console.warn(`No valid data provided for chart '${canvasId}'.`);
            return; 
        }

        try {
            // Ensure Chart object is available before using it
            if (typeof Chart === 'undefined') {
                console.error('Chart.js library is not loaded or available.');
                return;
            }
            const ctx = canvas.getContext("2d");
            new Chart(ctx, {
                type: chartType,
                data: chartData,
                options: chartOptions,
            });
        } catch (e) {
            console.error(`Error creating chart '${canvasId}':`, e);
        }
    }

    // --- Get Embedded Chart Data ---
    let userChartData = {};
    try {
        const chartDataElement = document.getElementById('userChartData');
        if (chartDataElement) {
            userChartData = JSON.parse(chartDataElement.textContent || '{}');
        } else {
             console.error("User chart data script tag not found.");
        }
    } catch (e) {
        console.error("Error parsing user chart data JSON:", e);
    }

    // --- Initialize Charts using the helper ---

    // 1. Score Trend Chart (Line)
    createChart(
        'scoreTrendChart',
        'line',
        {
            labels: userChartData.scoreLabels, // Timestamps
            datasets: [{
                label: 'Quiz Score (%)',
                data: userChartData.scoreData, 
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1,
                fill: false
            }]
        },
        { 
            responsive: true,
            scales: {
                y: { beginAtZero: true, max: 100, title: { display: true, text: 'Score (%)' } },
                x: {
                    type: 'time', 
                    time: { tooltipFormat: 'yyyy-MM-dd HH:mm', unit: 'day', displayFormats: { minute: 'HH:mm', hour: 'HH:mm', day: 'MMM d', month: 'MMM yyyy' } },
                    title: { display: true, text: 'Attempt Date & Time' },
                    ticks: { autoSkip: true, maxRotation: 45, minRotation: 0 }
                }
            },
            plugins: { legend: { display: false } /* tooltip config */ }
        }
    );

    // 2. Attempts per Subject Chart (Pie)
    createChart(
        'attemptsPerSubjectChart',
        'pie', 
        {
            labels: userChartData.attemptLabels, 
            datasets: [{
                label: 'Attempts',
                data: userChartData.attemptData, 
                backgroundColor: [ /* colors */ 
                    'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)',
                    'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)'
                    // Add more colors if needed
                ],
                hoverOffset: 4
            }]
        },
        { responsive: true, plugins: { legend: { position: 'top' } } } // Example options
    );

    // 3. Average Score per Subject Chart (Bar)
    createChart(
        'avgScorePerSubjectChart',
        'bar',
        {
            labels: userChartData.avgScoreLabels, 
            datasets: [{
                label: 'Average Score (%)',
                data: userChartData.avgScoreData, 
                backgroundColor: 'rgba(153, 102, 255, 0.6)', // Different color
                borderColor: 'rgba(153, 102, 255, 1)',
                borderWidth: 1
            }]
        },
        { 
            responsive: true, 
            scales: { y: { beginAtZero: true, max: 100 } },
            plugins: { legend: { display: false } }
        }
    );

});
</script>
{% endblock %}
